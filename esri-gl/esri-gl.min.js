!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).esrigl={})}(this,function(e){"use strict";function t(e){return e.replace(/\/$/,"")}function r(e,t={}){return new Promise((r,i)=>{fetch(`${e}?f=json`,t).then(e=>e.json()).then(e=>r(e)).catch(e=>i(e))})}const i='Powered by <a href="https://www.esri.com">Esri</a>';function s(e,t,r){const s=r,a=s._controls?.find(e=>"_attribHTML"in e);if(!a)return;const o=a.options?.customAttribution;"string"==typeof o?a.options.customAttribution=`${o} | ${i}`:void 0===o?a.options&&(a.options.customAttribution=i):Array.isArray(o)&&-1===o.indexOf(i)&&o.push(i);const n=r.style;if(n?.sourceCaches?.[t]?._source)n.sourceCaches[t]._source.attribution=e;else{if(!n?._otherSourceCaches?.[t]?._source)return void console.warn(`Source ${t} not found when trying to update attribution`);n._otherSourceCaches[t]._source.attribution=e}a._updateAttributions&&a._updateAttributions()}class a{constructor(e){if(Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_requestQueue",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"_authenticating",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"_serviceMetadata",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"_map",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_eventListeners",{enumerable:!0,configurable:!0,writable:!0,value:{}}),!e.url)throw new Error("A url must be supplied as part of the service options.");this.options={proxy:!1,useCors:!0,timeout:0,getAttributionFromService:!0,...e,url:t(e.url)}}async get(e,t={}){return this._request("GET",e,t)}async post(e,t={}){return this._request("POST",e,t)}async request(e,t={}){return this._request("GET",e,t)}requestWithCallback(e,t,r,i){if(!i)return this._request(e,t,r);this._requestWithCallback(e,t,r,i)}async metadata(){if(this._serviceMetadata)return this._serviceMetadata;try{const e=await this._request("GET","",{f:"json"});return this._serviceMetadata=e,this._serviceMetadata}catch(e){throw"undefined"!=typeof process&&"test"===process.env?.NODE_ENV||console.error("Error fetching service metadata:",e),e}}authenticate(e){return this._authenticating=!1,this.options.token=e,this._runQueue(),this}getTimeout(){return this.options.timeout}setTimeout(e){return this.options.timeout=e,this}async setAttributionFromService(){if(this._map)if(this._serviceMetadata)s(this._serviceMetadata.copyrightText||"","service",this._map);else try{if(await this.metadata(),this._serviceMetadata&&"object"==typeof this._serviceMetadata){const e=this._serviceMetadata;s(e?.copyrightText||"","service",this._map)}}catch(e){console.warn("Could not fetch service attribution:",e)}}on(e,t){return this._eventListeners[e]||(this._eventListeners[e]=[]),this._eventListeners[e].push(t),this}off(e,t){const r=this._eventListeners[e];if(r){const e=r.indexOf(t);e>-1&&r.splice(e,1)}return this}fire(e,t){const r=this._eventListeners[e];return r&&r.forEach(e=>e(t)),this}_requestWithCallback(e,t,r,i){this.fire("requeststart",{url:this.options.url+t,params:r,method:e});const s=this._createServiceCallback(e,t,r,(e,t)=>{i(e,t)});let a={...r};this.options.token&&(a.token=this.options.token),this.options.requestParams&&(a={...a,...this.options.requestParams}),this._authenticating?this._requestQueue.push([e,t,a,s,this]):this._makeRequest(e,t,a,s)}async _request(e,t,r){return this.fire("requeststart",{url:this.options.url+t,params:r,method:e}),new Promise((i,s)=>{const a=this._createServiceCallback(e,t,r,(e,t)=>{e?s(e):i(t)});let o={...r};this.options.token&&(o.token=this.options.token),this.options.requestParams&&(o={...o,...this.options.requestParams}),this._authenticating?this._requestQueue.push([e,t,o,a,this]):this._makeRequest(e,t,o,a)})}async _makeRequest(e,t,r,i){const s=this.options.proxy?`${this.options.proxy}?${this.options.url}${t}`:`${this.options.url}${t}`;try{let t;if("POST"===e){const e=new FormData;Object.keys(r).forEach(t=>{const i=r[t];null!=i&&("object"==typeof i?e.append(t,JSON.stringify(i)):e.append(t,i.toString()))}),t=await fetch(s,{method:"POST",body:e})}else{const e=new URLSearchParams;Object.keys(r).forEach(t=>{const i=r[t];null!=i&&(Array.isArray(i)?e.append(t,i.join(",")):"object"==typeof i?e.append(t,JSON.stringify(i)):e.append(t,i.toString()))});const i=`${s}?${e.toString()}`;t=await fetch(i)}if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);i(void 0,await t.json())}catch(e){i(e)}}_createServiceCallback(e,t,r,i){return(s,a)=>{const o=s;if(s&&(499===o.code||498===o.code)){this._authenticating=!0,this._requestQueue.push([e,t,r,i,this]),this.fire("authenticationrequired",{authenticate:e=>this.authenticate(e)});s.authenticate=e=>this.authenticate(e)}s?this.fire("requesterror",{url:this.options.url+t,params:r,message:s.message,code:o.code,method:e}):this.fire("requestsuccess",{url:this.options.url+t,params:r,response:a,method:e}),this.fire("requestend",{url:this.options.url+t,params:r,method:e}),i(s,a)}}_runQueue(){for(let e=this._requestQueue.length-1;e>=0;e--){const t=this._requestQueue[e],[r,i,s,a]=t;a&&this._makeRequest(r,i,s,a)}this._requestQueue=[]}}class o{constructor(e,t){Object.defineProperty(this,"styleName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_canonical",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_token",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_version",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_host",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_format",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_language",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_worldview",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const r=e&&e.trim()?e:"arcgis/streets";let i;if(this.styleName=r,this._canonical=o._toCanonical(r),i="string"==typeof t?{apiKey:t}:t||{},this._apiKey=i.apiKey,this._token=i.token,this._language=i.language,this._worldview=i.worldview,this._version=i.version||(this._token?"v2":"v1"),this._host=i.host||("v2"===this._version?"https://basemapstyles-api.arcgis.com":"https://basemaps-api.arcgis.com"),this._format=i.format||(this._version,"style"),!this._apiKey&&!this._token)throw new Error("An Esri API Key must be supplied to consume vector basemap styles")}get styleUrl(){if("v2"===this._version){const e=new URLSearchParams;return e.set("f",this._format),this._token&&e.set("token",this._token),this._language&&e.set("language",this._language),this._worldview&&e.set("worldview",this._worldview),`${this._host}/arcgis/rest/services/styles/v2/styles/${this._canonical}?${e.toString()}`}const e=new URLSearchParams;return e.set("type","style"),this._apiKey&&e.set("apiKey",this._apiKey),this._language&&e.set("language",this._language),this._worldview&&e.set("worldview",this._worldview),`${this._host}/arcgis/rest/services/styles/v1/styles/${this._canonical}?${e.toString()}`}setStyle(e){e&&(this.styleName=e,this._canonical=o._toCanonical(e))}update(){}remove(){}static applyStyle(e,t,r){const i=new o(t,r);e.setStyle(i.styleUrl)}static _toCanonical(e){if(!e)return"arcgis/streets";if(e.includes("/"))return e;const t=e.toLowerCase();if(this.COLON_TO_SLASH[t])return this.COLON_TO_SLASH[t];if(/^arcgis:/i.test(e)){const t=e.split(":")[1];if(t){return`arcgis/${t.replace(/([a-z])([A-Z])/g,"$1-$2").replace(/_/g,"-").toLowerCase()}`}}return e}}Object.defineProperty(o,"COLON_TO_SLASH",{enumerable:!0,configurable:!0,writable:!0,value:{"arcgis:streets":"arcgis/streets","arcgis:topographic":"arcgis/topographic","arcgis:navigation":"arcgis/navigation","arcgis:streetsrelief":"arcgis/streets-relief","arcgis:darkgray":"arcgis/dark-gray","arcgis:lightgray":"arcgis/light-gray","arcgis:oceans":"arcgis/oceans","arcgis:imagery":"arcgis/imagery","arcgis:streetsnight":"arcgis/streets-night"}});class n{constructor(e){if(Object.defineProperty(this,"_service",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"params",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"path",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"setters",{enumerable:!0,configurable:!0,writable:!0,value:{}}),e&&"object"==typeof e&&"request"in e?(this._service=e,this.options={}):"string"==typeof e?this.options={url:t(e)}:(this.options={...e},this.options.url&&(this.options.url=t(this.options.url))),this.params||(this.params={}),this.setters)for(const e in this.setters){const t=this.setters[e];this[e]=this.generateSetter(t,this)}}generateSetter(e,t){return function(r){return t.params[e]=r,t}}token(e){return this._service?this._service.authenticate(e):this.params.token=e,this}apikey(e){return this.token(e)}format(e){return this.params.returnUnformattedValues=!e,this}run(e){this.options.requestParams&&Object.assign(this.params,this.options.requestParams),this._service?this._service.requestWithCallback("POST",this.path,this.params,e):this._request("POST",this.path,this.params,e)}async request(){return this.options.requestParams&&Object.assign(this.params,this.options.requestParams),this._service?this._service.requestWithCallback("POST",this.path,this.params):new Promise((e,t)=>{this._request("POST",this.path,this.params,(r,i)=>{r?t(r):e(i)})})}_request(e,t,r,i){if(!this.options.url)return void i(new Error("URL is required for task execution"));const s=`${this.options.url.endsWith("/")?this.options.url.slice(0,-1):this.options.url}${t.startsWith("/")?t:`/${t}`}`,a=this.options.proxy?`${this.options.proxy}?${s}`:s,o=new URLSearchParams;Object.keys(r).forEach(e=>{const t=r[e];null!=t&&(Array.isArray(t)?o.append(e,t.join(",")):"object"==typeof t?o.append(e,JSON.stringify(t)):o.append(e,t.toString()))});const n="GET"===e?`${a}?${o.toString()}`:a,u={method:e,headers:{"Content-Type":"application/x-www-form-urlencoded"}};"POST"===e&&(u.body=o.toString()),fetch(n,u).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>i(void 0,e)).catch(e=>i(e))}}class u extends n{constructor(e){if(super(e),Object.defineProperty(this,"setters",{enumerable:!0,configurable:!0,writable:!0,value:{offset:"resultOffset",limit:"resultRecordCount",fields:"outFields",precision:"geometryPrecision",featureIds:"objectIds",returnGeometry:"returnGeometry",returnM:"returnM",transform:"datumTransformation",token:"token"}}),Object.defineProperty(this,"path",{enumerable:!0,configurable:!0,writable:!0,value:"query"}),Object.defineProperty(this,"params",{enumerable:!0,configurable:!0,writable:!0,value:{returnGeometry:!0,where:"1=1",outSR:4326,outFields:"*",f:"json"}}),this.path="query",e&&"object"==typeof e&&!("request"in e)&&"string"!=typeof e){const t=e;void 0!==t.where&&(this.params.where=t.where),void 0!==t.outFields&&(this.params.outFields=t.outFields),void 0!==t.returnGeometry&&(this.params.returnGeometry=t.returnGeometry),void 0!==t.spatialRel&&(this.params.spatialRel=t.spatialRel),void 0!==t.geometry&&(this.params.geometry=t.geometry),void 0!==t.geometryType&&(this.params.geometryType=t.geometryType),void 0!==t.inSR&&(this.params.inSR=t.inSR),void 0!==t.outSR&&(this.params.outSR=t.outSR),void 0!==t.returnDistinctValues&&(this.params.returnDistinctValues=t.returnDistinctValues),void 0!==t.returnIdsOnly&&(this.params.returnIdsOnly=t.returnIdsOnly),void 0!==t.returnCountOnly&&(this.params.returnCountOnly=t.returnCountOnly),void 0!==t.returnExtentOnly&&(this.params.returnExtentOnly=t.returnExtentOnly),void 0!==t.orderByFields&&(this.params.orderByFields=t.orderByFields),void 0!==t.groupByFieldsForStatistics&&(this.params.groupByFieldsForStatistics=t.groupByFieldsForStatistics),void 0!==t.outStatistics&&(this.params.outStatistics=t.outStatistics),void 0!==t.resultOffset&&(this.params.resultOffset=t.resultOffset),void 0!==t.resultRecordCount&&(this.params.resultRecordCount=t.resultRecordCount),void 0!==t.maxAllowableOffset&&(this.params.maxAllowableOffset=t.maxAllowableOffset),void 0!==t.geometryPrecision&&(this.params.geometryPrecision=t.geometryPrecision),void 0!==t.time&&(this.params.time=t.time),void 0!==t.gdbVersion&&(this.params.gdbVersion=t.gdbVersion),void 0!==t.historicMoment&&(this.params.historicMoment=t.historicMoment),void 0!==t.returnTrueCurves&&(this.params.returnTrueCurves=t.returnTrueCurves),void 0!==t.returnZ&&(this.params.returnZ=t.returnZ),void 0!==t.returnM&&(this.params.returnM=t.returnM),void 0!==t.token&&(this.params.token=t.token)}}within(e){return this._setGeometryParams(e),this.params.spatialRel="esriSpatialRelContains",this}intersects(e){return this._setGeometryParams(e),this.params.spatialRel="esriSpatialRelIntersects",this}contains(e){return this._setGeometryParams(e),this.params.spatialRel="esriSpatialRelWithin",this}crosses(e){return this._setGeometryParams(e),this.params.spatialRel="esriSpatialRelCrosses",this}touches(e){return this._setGeometryParams(e),this.params.spatialRel="esriSpatialRelTouches",this}overlaps(e){return this._setGeometryParams(e),this.params.spatialRel="esriSpatialRelOverlaps",this}bboxIntersects(e){return this._setGeometryParams(e),this.params.spatialRel="esriSpatialRelEnvelopeIntersects",this}nearby(e,t){return this.params.geometry=[e.lng,e.lat],this.params.geometryType="esriGeometryPoint",this.params.spatialRel="esriSpatialRelIntersects",this.params.units="esriSRUnit_Meter",this.params.distance=t,this.params.inSR=4326,this}where(e){return this.params.where=e,this}between(e,t){const r=e instanceof Date?e.valueOf():e,i=t instanceof Date?t.valueOf():t;return this.params.time=[r,i],this}simplify(e,t){const r=e.getBounds(),i=Math.abs(r._northEast.lng-r._southWest.lng);return this.params.maxAllowableOffset=i/e.getSize().x*t,this}orderBy(e,t="ASC"){const r=this.params.orderByFields||"";return this.params.orderByFields=r?`${r},${e} ${t}`:`${e} ${t}`,this}layer(e){return this.path=`${e}/query`,this}distinct(){return this.params.returnGeometry=!1,this.params.returnDistinctValues=!0,this}pixelSize(e){return this.params.pixelSize=[e.x,e.y],this}async run(){this._cleanParams(),this.params.f="geojson";try{return await this.request()}catch{this.params.f="json";const e=await this.request();return this._convertToGeoJSON(e)}}async count(){this._cleanParams(),this.params.returnCountOnly=!0;return(await this.request()).count}async ids(){this._cleanParams(),this.params.returnIdsOnly=!0;return(await this.request()).objectIds}async bounds(){this._cleanParams(),this.params.returnExtentOnly=!0;const e=await this.request();if(!e.extent)throw new Error("Invalid bounds returned");return{_southWest:{lat:e.extent.ymin,lng:e.extent.xmin},_northEast:{lat:e.extent.ymax,lng:e.extent.xmax}}}_setGeometryParams(e){this.params.inSR=4326;const t=this._setGeometry(e);this.params.geometry=t.geometry,this.params.geometryType=t.geometryType}_setGeometry(e){if(!e)return{geometry:null,geometryType:"esriGeometryPoint"};if("object"==typeof e&&null!==e){const t=e;if("lat"in t&&"lng"in t)return{geometry:{x:t.lng,y:t.lat,spatialReference:{wkid:4326}},geometryType:"esriGeometryPoint"};if("_southWest"in t&&"_northEast"in t){const e=t;return{geometry:{xmin:e._southWest.lng,ymin:e._southWest.lat,xmax:e._northEast.lng,ymax:e._northEast.lat,spatialReference:{wkid:4326}},geometryType:"esriGeometryEnvelope"}}if("xmin"in t&&"ymin"in t&&"xmax"in t&&"ymax"in t)return{geometry:e,geometryType:"esriGeometryEnvelope"}}return{geometry:e,geometryType:"esriGeometryPoint"}}_cleanParams(){delete this.params.returnIdsOnly,delete this.params.returnExtentOnly,delete this.params.returnCountOnly,delete this.params.returnDistinctValues}_convertToGeoJSON(e){return{type:"FeatureCollection",features:(e.features||[]).map(e=>({type:"Feature",properties:e.attributes,geometry:e.geometry||null}))}}}class l extends n{constructor(e){if(super(e),Object.defineProperty(this,"setters",{enumerable:!0,configurable:!0,writable:!0,value:{contains:"contains",text:"searchText",fields:"searchFields",spatialReference:"sr",sr:"sr",layers:"layers",returnGeometry:"returnGeometry",maxAllowableOffset:"maxAllowableOffset",precision:"geometryPrecision",dynamicLayers:"dynamicLayers",returnZ:"returnZ",returnM:"returnM",gdbVersion:"gdbVersion",token:"token"}}),Object.defineProperty(this,"path",{enumerable:!0,configurable:!0,writable:!0,value:"find"}),Object.defineProperty(this,"params",{enumerable:!0,configurable:!0,writable:!0,value:{searchText:"",layers:"all",contains:!0,returnGeometry:!0,f:"json"}}),this.path="find",e&&"object"==typeof e&&!("request"in e)&&"string"!=typeof e){const t=e;void 0!==t.searchText&&(this.params.searchText=t.searchText),void 0!==t.contains&&(this.params.contains=t.contains),void 0!==t.searchFields&&(this.params.searchFields=Array.isArray(t.searchFields)?t.searchFields.join(","):t.searchFields),void 0!==t.sr&&(this.params.sr=t.sr),void 0!==t.layers&&(Array.isArray(t.layers)?this.params.layers=t.layers.join(","):"string"==typeof t.layers?this.params.layers=t.layers:this.params.layers=t.layers.toString()),void 0!==t.returnGeometry&&(this.params.returnGeometry=t.returnGeometry),void 0!==t.maxAllowableOffset&&(this.params.maxAllowableOffset=t.maxAllowableOffset),void 0!==t.geometryPrecision&&(this.params.geometryPrecision=t.geometryPrecision),void 0!==t.dynamicLayers&&(this.params.dynamicLayers=t.dynamicLayers),void 0!==t.returnZ&&(this.params.returnZ=t.returnZ),void 0!==t.returnM&&(this.params.returnM=t.returnM),void 0!==t.gdbVersion&&(this.params.gdbVersion=t.gdbVersion),void 0!==t.layerDefs&&(this.params.layerDefs=t.layerDefs),void 0!==t.token&&(this.params.token=t.token)}}text(e){return this.params.searchText=e,this}fields(e){return this.params.searchFields=Array.isArray(e)?e.join(","):e,this}contains(e){return this.params.contains=e,this}layers(e){return Array.isArray(e)?this.params.layers=e.join(","):this.params.layers=e,this}layerDefs(e,t){const r=this.params.layerDefs||"";return this.params.layerDefs=r?`${r};${e}:${t}`:`${e}:${t}`,this}simplify(e,t){const r=e.getBounds(),i=Math.abs(r.getWest()-r.getEast());return this.params.maxAllowableOffset=i/e.getSize().x*t,this}async run(){this.params.f="json";try{const e=await this.request();return this._convertToGeoJSON(e)}catch(e){throw"undefined"!=typeof process&&"test"===process.env?.NODE_ENV||console.error("Find task error:",e),e}}_convertToGeoJSON(e){return{type:"FeatureCollection",features:(e?.results||[]).map(e=>({type:"Feature",properties:{...e.attributes,layerId:e.layerId,layerName:e.layerName,foundFieldName:e.foundFieldName,value:e.value},geometry:this._convertEsriGeometry(e.geometry)}))}}_convertEsriGeometry(e){if(!e||"object"!=typeof e)return null;const t=e;if("x"in t&&"y"in t)return{type:"Point",coordinates:[t.x,t.y]};if("rings"in t&&Array.isArray(t.rings))return{type:"Polygon",coordinates:t.rings};if("paths"in t&&Array.isArray(t.paths)){const e=t.paths;return 1===e.length?{type:"LineString",coordinates:e[0]}:{type:"MultiLineString",coordinates:e}}return null}}class c extends n{constructor(e){if(super(e),Object.defineProperty(this,"setters",{enumerable:!0,configurable:!0,writable:!0,value:{returnCatalogItems:"returnCatalogItems",returnGeometry:"returnGeometry",pixelSize:"pixelSize",token:"token"}}),Object.defineProperty(this,"path",{enumerable:!0,configurable:!0,writable:!0,value:"identify"}),Object.defineProperty(this,"params",{enumerable:!0,configurable:!0,writable:!0,value:{sr:4326,returnGeometry:!1,returnCatalogItems:!1,f:"json"}}),e&&"object"==typeof e&&"string"!=typeof e){const t=e;void 0!==t.geometry&&(this.params.geometry=t.geometry),void 0!==t.geometryType&&(this.params.geometryType=t.geometryType),void 0!==t.sr&&(this.params.sr=t.sr),void 0!==t.mosaic&&(this.params.mosaic=t.mosaic),void 0!==t.renderingRules&&(this.params.renderingRules=t.renderingRules),void 0!==t.pixelSize&&(this.params.pixelSize=t.pixelSize),void 0!==t.returnGeometry&&(this.params.returnGeometry=t.returnGeometry),void 0!==t.returnCatalogItems&&(this.params.returnCatalogItems=t.returnCatalogItems),void 0!==t.token&&(this.params.token=t.token),void 0!==t.f&&(this.params.f=t.f)}}at(e){let t;return t=Array.isArray(e)?{x:e[0],y:e[1],spatialReference:{wkid:4326}}:{x:e.lng,y:e.lat,spatialReference:{wkid:4326}},this.params.geometry=JSON.stringify(t),this.params.geometryType="esriGeometryPoint",this.params.sr=4326,this}geometry(e,t){return this.params.geometry=JSON.stringify(e),this.params.geometryType=t||"esriGeometryPoint",this}pixelSize(e){return Array.isArray(e)?this.params.pixelSize=`${e[0]},${e[1]}`:this.params.pixelSize=`${e.x},${e.y}`,this}returnGeometry(e){return this.params.returnGeometry=e,this}returnCatalogItems(e){return this.params.returnCatalogItems=e,this}mosaicRule(e){return this.params.mosaicRule=JSON.stringify(e),this}renderingRule(e){return this.params.renderingRule=JSON.stringify(e),this}async run(){const e=await this.request();let t=[];return e.results?t=e.results:(void 0!==e.value||e.values)&&(t=[{value:e.value||e.values&&e.values[0]||"",attributes:e.properties||{}}]),{results:t,location:e.location}}async getPixelValues(){return(await this.run()).results.map(e=>{if(void 0!==e.value){const t=parseFloat(e.value);return isNaN(t)?e.value:t}return null})}async getPixelData(){return(await this.run()).results}}e.DynamicMapService=class{constructor(e,r,i,s){if(Object.defineProperty(this,"_sourceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_map",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_defaultEsriOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serviceMetadata",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"_pendingUpdate",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"_lastUpdateTime",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_updateDelay",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"rasterSrcOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"esriServiceOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_pendingUpdates",{enumerable:!0,configurable:!0,writable:!0,value:null}),!i.url)throw new Error("A url must be supplied as part of the esriServiceOptions object.");i.url=t(i.url),this._sourceId=e,this._map=r,this._defaultEsriOptions={layers:!1,layerDefs:!1,dynamicLayers:!1,format:"png24",dpi:96,transparent:!0,getAttributionFromService:!0},this.rasterSrcOptions=s,this.esriServiceOptions=i,this._createSource(),this.options.getAttributionFromService&&this.setAttributionFromService().catch(()=>{})}get options(){return{...this._defaultEsriOptions,...this.esriServiceOptions}}get _layersStr(){let e=this.options.layers;return!!e&&(Array.isArray(e)||(e=[e]),`show:${e.join(",")}`)}get _layerDefs(){return!1!==this.options.layerDefs&&JSON.stringify(this.options.layerDefs)}get _time(){if(!this.options.to)return!1;let e=this.options.from,t=this.options.to;return e instanceof Date&&(e=e.valueOf()),t instanceof Date&&(t=t.valueOf()),`${e},${t}`}get _dynamicLayers(){const e=this.options.dynamicLayers;if(!e)return!1;try{const t=e.map(e=>{const{visible:t,...r}=e,i={...r,source:e.source??{type:"mapLayer",mapLayerId:e.id}};return"boolean"==typeof t&&(i.visibility=t),i});return JSON.stringify(t)}catch{return!1}}get _source(){const e=this.rasterSrcOptions?.tileSize??256,t=new URLSearchParams({bboxSR:"3857",imageSR:"3857",format:this.options.format,layers:this._layersStr||"",transparent:this.options.transparent.toString(),size:`${e},${e}`,f:"image"});this._time&&t.append("time",this._time),this._layerDefs&&t.append("layerDefs",this._layerDefs),this._dynamicLayers&&t.append("dynamicLayers",this._dynamicLayers);return{type:"raster",tiles:[`${this.options.url}/export?bbox={bbox-epsg-3857}&${t.toString()}`],tileSize:e,...this.rasterSrcOptions}}_createSource(){this._map.getSource(this._sourceId)||this._map.addSource(this._sourceId,this._source)}_updateSource(){const e=performance.now();if(e-this._lastUpdateTime<this._updateDelay)return this._pendingUpdate&&cancelAnimationFrame(this._pendingUpdate),void(this._pendingUpdate=requestAnimationFrame(()=>this._updateSourceInternal()));this._lastUpdateTime=e,this._updateSourceInternal()}_updateSourceInternal(){const e=this._map.getSource(this._sourceId);if(e)try{if(e.tiles&&Array.isArray(e.tiles)&&this._source.tiles&&this._source.tiles.length>0&&(e.tiles[0]=this._source.tiles[0]),e._options=this._source,e.setTiles){const t=e.setTiles(this._source.tiles);t&&"function"==typeof t.catch&&t.catch(()=>{})}else(this._map.style.sourceCaches||this._map.style._otherSourceCaches)&&(this._map.style.sourceCaches[this._sourceId].clearTiles(),this._map.style.sourceCaches[this._sourceId].update(this._map.transform))}catch(e){const t=e?.name,r=e?.message,i=e?.constructor?.name;let s="";try{s=String(e)}catch{}if(e instanceof DOMException&&"AbortError"===e.name||e instanceof Error&&"AbortError"===e.name||"AbortError"===t||"AbortError"===i||r?.toLowerCase().includes("abort")||s.toLowerCase().includes("abort")||r?.includes("AbortError")||s.includes("AbortError")||"Error: AbortError"===s||"AbortError"===e)return;if(e&&e.message?.includes("Source")&&e.message?.includes("not found"))return;throw e}}setLayerDefs(e){this.esriServiceOptions.layerDefs=e,this._updateSource()}setDynamicLayers(e){this.esriServiceOptions.dynamicLayers=e||!1,this._updateSource()}_ensureAllVisibleLayers(e){const t=this._getVisibleLayerIds(),r=new Set(e.map(e=>e.id)),i=t.filter(e=>!r.has(e)).map(e=>({id:e,visible:!0}));return[...e,...i]}_getVisibleLayerIds(){const e=this.options.layers;return e?Array.isArray(e)?e:[e]:[]}setLayerDrawingInfo(e,t){const r=this.esriServiceOptions.dynamicLayers||[],i=Array.isArray(r)?[...r]:[],s=i.findIndex(t=>t.id===e);s>=0?i[s]={...i[s],drawingInfo:{...i[s].drawingInfo,...t}}:i.push({id:e,drawingInfo:t}),this.esriServiceOptions.dynamicLayers=this._ensureAllVisibleLayers(i),this._updateSource()}setLayerRenderer(e,t){this.setLayerDrawingInfo(e,{renderer:t})}setLayerVisibility(e,t){const r=this.esriServiceOptions.dynamicLayers||[],i=Array.isArray(r)?[...r]:[],s=i.findIndex(t=>t.id===e);s>=0?i[s]={...i[s],visible:t}:i.push({id:e,visible:t}),this.esriServiceOptions.dynamicLayers=this._ensureAllVisibleLayers(i),this._updateSource()}setLayerDefinition(e,t){const r=this.esriServiceOptions.dynamicLayers||[],i=Array.isArray(r)?[...r]:[],s=i.findIndex(t=>t.id===e);s>=0?i[s]={...i[s],definitionExpression:t}:i.push({id:e,definitionExpression:t}),this.esriServiceOptions.dynamicLayers=this._ensureAllVisibleLayers(i),this._updateSource()}setLayerFilter(e,t){const r=this._buildWhere(t);r&&this.setLayerDefinition(e,r)}_escapeValue(e){if(null===e)return"NULL";if(e instanceof Date)return`${e.valueOf()}`;if("number"==typeof e)return`${e}`;if("boolean"==typeof e)return e?"1":"0";return`'${String(e).replace(/'/g,"''")}'`}_isGroupFilter(e){return"string"!=typeof e&&"op"in e&&("AND"===e.op||"OR"===e.op)&&"filters"in e&&Array.isArray(e.filters)}_isBetweenFilter(e){return"string"!=typeof e&&"op"in e&&"BETWEEN"===e.op&&"field"in e&&"string"==typeof e.field&&"from"in e&&void 0!==e.from&&"to"in e&&void 0!==e.to}_isInFilter(e){return"string"!=typeof e&&"op"in e&&"IN"===e.op&&"field"in e&&"string"==typeof e.field&&"values"in e&&Array.isArray(e.values)}_isNullFilter(e){return"string"!=typeof e&&"op"in e&&("IS NULL"===e.op||"IS NOT NULL"===e.op)&&"field"in e&&"string"==typeof e.field}_isComparisonFilter(e){return"string"!=typeof e&&"field"in e&&"string"==typeof e.field&&"op"in e&&"string"==typeof e.op&&"value"in e&&void 0!==e.value}_buildWhere(e){if(e){if("string"==typeof e)return e.trim();if(this._isBetweenFilter(e))return`${e.field} BETWEEN ${this._escapeValue(e.from)} AND ${this._escapeValue(e.to)}`;if(this._isInFilter(e)){const t=e.values.map(e=>this._escapeValue(e)).join(", ");return`${e.field} IN (${t})`}if(this._isNullFilter(e))return`${e.field} ${e.op}`;if(this._isGroupFilter(e)){const t=e.filters.map(e=>this._buildWhere(e)).filter(e=>Boolean(e));if(!t.length)return;return 1===t.length?t[0]:`(${t.join(` ${e.op} `)})`}return this._isComparisonFilter(e)?`${e.field} ${e.op} ${this._escapeValue(e.value)}`:void 0}}setLayers(e){this.esriServiceOptions.layers=e,this._updateSource()}setDate(e,t){this.esriServiceOptions.from=e,this.esriServiceOptions.to=t,this._updateSource()}setAttributionFromService(){return this._serviceMetadata?(s(this._serviceMetadata.copyrightText||"",this._sourceId,this._map),Promise.resolve()):this.getMetadata().then(()=>{s(this._serviceMetadata?.copyrightText||"",this._sourceId,this._map)})}getMetadata(){return null!==this._serviceMetadata?Promise.resolve(this._serviceMetadata):new Promise((e,t)=>{r(this.esriServiceOptions.url,this.esriServiceOptions.fetchOptions).then(t=>{this._serviceMetadata=t,e(this._serviceMetadata)}).catch(e=>t(e))})}get _layersStrIdentify(){const e=this._layersStr;return!!e&&e.replace("show","visible")}identify(e,t=!1){const r=this._map.getCanvas(),i=this._map.getBounds().toArray(),s=new URLSearchParams({sr:"4326",geometryType:"esriGeometryPoint",geometry:JSON.stringify({x:e.lng,y:e.lat,spatialReference:{wkid:4326}}),tolerance:"3",returnGeometry:t.toString(),imageDisplay:`${r.width},${r.height},96`,mapExtent:`${i[0][0]},${i[0][1]},${i[1][0]},${i[1][1]}`,layers:this._layersStrIdentify||"",f:"json"});return this._layerDefs&&s.append("layerDefs",this._layerDefs),this._dynamicLayers&&s.append("dynamicLayers",this._dynamicLayers),this._time&&s.append("time",this._time),new Promise((e,t)=>{fetch(`${this.esriServiceOptions.url}/identify?${s.toString()}`,this.esriServiceOptions.fetchOptions).then(e=>e.json()).then(t=>e(t)).catch(e=>t(e))})}setLayerLabels(e,t){const r=this.esriServiceOptions.dynamicLayers||[],i=Array.isArray(r)?[...r]:[],s=i.findIndex(t=>t.id===e);s>=0?i[s]={...i[s],drawingInfo:{...i[s].drawingInfo,labelingInfo:[t]}}:i.push({id:e,drawingInfo:{labelingInfo:[t]}}),this.esriServiceOptions.dynamicLayers=this._ensureAllVisibleLayers(i),this._updateSource()}setLayerLabelsVisible(e,t){if(t){const t=this.esriServiceOptions.dynamicLayers||[],r=Array.isArray(t)?t.find(t=>t.id===e):null;r?.drawingInfo?.labelingInfo||this.setLayerLabels(e,{labelExpression:"[OBJECTID]",symbol:{type:"esriTS",color:[0,0,0,255],font:{family:"Arial",size:8}}})}else{const t=this.esriServiceOptions.dynamicLayers||[],r=Array.isArray(t)?[...t]:[],i=r.findIndex(t=>t.id===e);if(i>=0){const e={...r[i].drawingInfo};delete e.labelingInfo,r[i]={...r[i],drawingInfo:e},this.esriServiceOptions.dynamicLayers=this._ensureAllVisibleLayers(r),this._updateSource()}}}setLayerTimeOptions(e,t){const r=this.esriServiceOptions.dynamicLayers||[],i=Array.isArray(r)?[...r]:[],s=i.findIndex(t=>t.id===e);s>=0?i[s]={...i[s],layerTimeOptions:t}:i.push({id:e,layerTimeOptions:t}),this.esriServiceOptions.dynamicLayers=this._ensureAllVisibleLayers(i),this._updateSource()}async animateTime(e){const{from:t,to:r,intervalMs:i,loop:s=!1,onFrame:a,onComplete:o}=e,n=r.getTime()-t.getTime(),u=Math.ceil(n/i);return new Promise(e=>{let r=0;const l=()=>{if(r>=u&&!s)return o?.(),void e();const c=r%u/u,h=new Date(t.getTime()+c*n);this.esriServiceOptions.from=h,this.esriServiceOptions.to=h,this._updateSource(),a?.(h,c),r++,setTimeout(l,i)};l()})}async getLayerStatistics(e,t,r={}){const i=`${this.esriServiceOptions.url}/${e}/query`,s=new URLSearchParams({f:"json",where:r.where||"1=1",outStatistics:JSON.stringify(t),returnGeometry:"false"});r.groupByFieldsForStatistics&&s.append("groupByFieldsForStatistics",r.groupByFieldsForStatistics);const a=await fetch(`${i}?${s.toString()}`),o=await a.json();if(o.error)throw new Error(`Statistics query failed: ${o.error.message}`);return o.features||[]}async queryLayerFeatures(e,t={}){const r=`${this.esriServiceOptions.url}/${e}/query`,i=new URLSearchParams({f:"json",where:t.where||"1=1",returnGeometry:!1!==t.returnGeometry?"true":"false",outFields:Array.isArray(t.outFields)?t.outFields.join(","):t.outFields||"*"});t.geometry&&(i.append("geometry",JSON.stringify(t.geometry)),i.append("geometryType",t.geometryType||"esriGeometryEnvelope"),i.append("spatialRel",t.spatialRel||"esriSpatialRelIntersects")),t.orderByFields&&i.append("orderByFields",t.orderByFields),t.resultOffset&&i.append("resultOffset",t.resultOffset.toString()),t.resultRecordCount&&i.append("resultRecordCount",t.resultRecordCount.toString()),t.returnCountOnly&&i.append("returnCountOnly","true"),t.returnIdsOnly&&i.append("returnIdsOnly","true");const s=await fetch(`${r}?${i.toString()}`),a=await s.json();if(a.error)throw new Error(`Layer query failed: ${a.error.message}`);return a}async exportMapImage(e){const t=`${this.esriServiceOptions.url}/export`,r=new URLSearchParams({f:"image",bbox:e.bbox.join(","),size:e.size.join(","),format:e.format||"png24",transparent:!1!==e.transparent?"true":"false",dpi:(e.dpi||96).toString(),bboxSR:(e.bboxSR||3857).toString(),imageSR:(e.imageSR||3857).toString()});if(e.layerDefs&&r.append("layerDefs",JSON.stringify(e.layerDefs)),e.dynamicLayers){const t=this._ensureAllVisibleLayers(e.dynamicLayers);r.append("dynamicLayers",JSON.stringify(t))}e.gdbVersion&&r.append("gdbVersion",e.gdbVersion),e.historicMoment&&r.append("historicMoment",e.historicMoment.toString());const i=await async function(e,t,r,i=1024){const s=`${e}?${t.toString()}`;return s.length<i?(console.info(`URL is ${s.length} chars long, using GET`),await fetch(s,r)):(console.warn(`URL is ${s.length} chars long, using POST`),await fetch(e,{...r,method:"POST",body:t}))}(t,r);if(!i.ok)throw new Error(`Export failed: ${i.statusText}`);return i.blob()}async generateLegend(e){const t=`${this.esriServiceOptions.url}/legend`,r=new URLSearchParams({f:"json"});e?.length&&r.append("layers",e.join(","));const i=await fetch(`${t}?${r.toString()}`),s=await i.json();if(s.error)throw new Error(`Legend generation failed: ${s.error.message}`);return s.layers||[]}async getLayerInfo(e){const t=`${this.esriServiceOptions.url}/${e}`,r=new URLSearchParams({f:"json"}),i=await fetch(`${t}?${r.toString()}`),s=await i.json();if(s.error)throw new Error(`Layer info request failed: ${s.error.message}`);return s}async getLayerFields(e){return(await this.getLayerInfo(e)).fields||[]}async getLayerExtent(e){const t=await this.getLayerInfo(e);if(!t.extent)throw new Error(`No extent available for layer ${e}`);return t.extent}async discoverLayers(){const e=this.esriServiceOptions.url,t=new URLSearchParams({f:"json"}),r=await fetch(`${e}?${t.toString()}`),i=await r.json();if(i.error)throw new Error(`Service discovery failed: ${i.error.message}`);return i.layers||[]}setBulkLayerProperties(e){const t=this.esriServiceOptions.dynamicLayers||[],r=Array.isArray(t)?[...t]:[];for(const t of e){const e=r.findIndex(e=>e.id===t.layerId),i=e>=0?{...r[e]}:{id:t.layerId};switch(t.operation){case"visibility":i.visible=t.value;break;case"renderer":i.drawingInfo={...i.drawingInfo,renderer:t.value};break;case"definition":i.definitionExpression=t.value;break;case"filter":{const e=this._buildWhere(t.value);e&&(i.definitionExpression=e);break}case"labels":i.drawingInfo={...i.drawingInfo,labelingInfo:t.value};break;case"time":i.layerTimeOptions=t.value}e>=0?r[e]=i:r.push(i)}this.esriServiceOptions.dynamicLayers=this._ensureAllVisibleLayers(r),this._updateSource()}beginUpdate(){const e=this.esriServiceOptions.dynamicLayers||[];this._pendingUpdates=Array.isArray(e)?[...e]:[]}commitUpdate(){this._pendingUpdates&&(this.esriServiceOptions.dynamicLayers=this._ensureAllVisibleLayers(this._pendingUpdates),this._pendingUpdates=null,this._updateSource())}rollbackUpdate(){this._pendingUpdates=null}get isInTransaction(){return null!==this._pendingUpdates}update(){this._updateSource()}remove(){const e=this._map;if(e&&"function"==typeof e.removeSource)try{const t=e,r=e,i=e;if("function"==typeof t.getStyle){const e=t.getStyle();(e?.layers||[]).forEach(e=>{if(e.source!==this._sourceId)return;if("function"!=typeof r.getLayer||"function"!=typeof r.removeLayer)return;let t=!1;try{t=Boolean(r.getLayer(e.id))}catch{t=!1}if(t)try{r.removeLayer(e.id)}catch(t){console.warn(`Failed to remove layer ${e.id} for source ${this._sourceId}:`,t)}})}if("function"==typeof i.getSource){let t=!1;try{t=Boolean(i.getSource(this._sourceId))}catch{t=!1}if(t)try{e.removeSource(this._sourceId)}catch(e){console.warn(`Failed to remove source ${this._sourceId}:`,e)}}}catch(e){console.warn(`Failed to remove source ${this._sourceId}:`,e)}}},e.FeatureService=class{constructor(e,r,i,s){if(Object.defineProperty(this,"_sourceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_map",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_defaultEsriOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serviceMetadata",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"_defaultStyleData",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"_boundingBoxUpdateHandler",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"vectorSrcOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"esriServiceOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!i.url)throw new Error("A url must be supplied as part of the esriServiceOptions object.");i.url=t(i.url),this._sourceId=e,this._map=r,this._defaultEsriOptions={where:"1=1",outFields:"*",f:"geojson",returnGeometry:!0,token:""},this.vectorSrcOptions=s,this.esriServiceOptions=i,void 0===this.esriServiceOptions.useVectorTiles&&(this.esriServiceOptions.useVectorTiles=!0),void 0===this.esriServiceOptions.useBoundingBox&&(this.esriServiceOptions.useBoundingBox=!0),this._createSource()}async _createSource(){if(this._map)try{let e=!1!==this.esriServiceOptions.useVectorTiles;if(e&&(e=await this._checkVectorTileSupport()),e){const e=this._buildTileUrl();this._map.getSource(this._sourceId)||this._map.addSource(this._sourceId,{type:"vector",tiles:[e],maxzoom:24,...this.vectorSrcOptions})}else{const e=this._buildQueryUrl();this._map.getSource(this._sourceId)||this._map.addSource(this._sourceId,{type:"geojson",data:e})}this._serviceMetadata=await r(this.esriServiceOptions.url,this.esriServiceOptions.fetchOptions),this._serviceMetadata?.copyrightText&&s(this._serviceMetadata.copyrightText,this._sourceId,this._map),!e&&this.esriServiceOptions.useBoundingBox&&this._setupBoundingBoxUpdates()}catch(e){"undefined"!=typeof process&&"test"===process.env?.NODE_ENV||console.error("Error creating FeatureService source:",e)}}async _checkVectorTileSupport(){try{const e=this.esriServiceOptions.url.replace("/FeatureServer/","/VectorTileServer/");if(e===this.esriServiceOptions.url)return!1;const t=await fetch(e+"?f=json",this.esriServiceOptions.fetchOptions);if(t.ok){const e=await t.json();return!(!e||e.error)}return!1}catch{return!1}}_buildTileUrl(){return`${this.esriServiceOptions.url.replace("/FeatureServer/","/VectorTileServer/")}/tile/{z}/{y}/{x}.pbf`}_buildQueryUrl(){const e={...this._defaultEsriOptions,...this.esriServiceOptions},t=`${e.url}/query`,r=new URLSearchParams;if(r.append("where",e.where||"1=1"),r.append("outFields",Array.isArray(e.outFields)?e.outFields.join(","):e.outFields||"*"),r.append("f",e.f||"geojson"),r.append("returnGeometry",(!1!==e.returnGeometry).toString()),!1!==e.useBoundingBox&&this._map){const e=this._map.getBounds();if(e){const t={xmin:e.getWest(),ymin:e.getSouth(),xmax:e.getEast(),ymax:e.getNorth(),spatialReference:{wkid:4326}};r.append("geometry",JSON.stringify(t)),r.append("geometryType","esriGeometryEnvelope"),r.append("spatialRel","esriSpatialRelIntersects"),r.append("inSR","4326")}}return e.geometry&&!1===e.useBoundingBox&&(r.append("geometry",JSON.stringify(e.geometry)),e.geometryType&&r.append("geometryType",e.geometryType),e.spatialRel&&r.append("spatialRel",e.spatialRel),e.inSR&&r.append("inSR",e.inSR)),e.outSR&&r.append("outSR",e.outSR),e.orderByFields&&r.append("orderByFields",e.orderByFields),e.groupByFieldsForStatistics&&r.append("groupByFieldsForStatistics",e.groupByFieldsForStatistics),e.outStatistics&&e.outStatistics.length>0&&r.append("outStatistics",JSON.stringify(e.outStatistics)),e.having&&r.append("having",e.having),e.resultOffset&&r.append("resultOffset",e.resultOffset.toString()),e.resultRecordCount&&r.append("resultRecordCount",e.resultRecordCount.toString()),e.token&&r.append("token",e.token),`${t}?${r.toString()}`}get _source(){return this._map.getSource(this._sourceId)}get _url(){return this._buildQueryUrl()}get serviceMetadata(){return this._serviceMetadata}get defaultStyle(){if(this._defaultStyleData)return this._defaultStyleData;const e=String(this._serviceMetadata?.geometryType||"esriGeometryPoint"),t=!1!==this.esriServiceOptions.useVectorTiles,r={source:this._sourceId};return t&&this._serviceMetadata?.name&&(r["source-layer"]=String(this._serviceMetadata.name)),e.includes("Point")?{type:"circle",...r,paint:{"circle-radius":4,"circle-color":"#3b82f6","circle-stroke-color":"#1e40af","circle-stroke-width":1}}:e.includes("Polyline")?{type:"line",...r,paint:{"line-color":"#3b82f6","line-width":2}}:e.includes("Polygon")?{type:"fill",...r,paint:{"fill-color":"rgba(59, 130, 246, 0.4)","fill-outline-color":"#1e40af"}}:{type:"circle",...r,paint:{"circle-radius":4,"circle-color":"#3b82f6","circle-stroke-color":"#1e40af","circle-stroke-width":1}}}getStyle(){return new Promise((e,t)=>{this._serviceMetadata?e(this.defaultStyle):this._getServiceMetadata().then(()=>e(this.defaultStyle)).catch(e=>t(e))})}async _getServiceMetadata(){this._serviceMetadata||(this._serviceMetadata=await r(this.esriServiceOptions.url,this.esriServiceOptions.fetchOptions))}updateData(){if(!1===this.esriServiceOptions.useVectorTiles&&this.esriServiceOptions.useBoundingBox){const e=this._map.getSource(this._sourceId);if(e&&"setData"in e&&"function"==typeof e.setData){const t=this._buildQueryUrl();e.setData(t)}}else console.warn("updateData() is only applicable for GeoJSON sources with bounding box filtering.")}_setupBoundingBoxUpdates(){this._boundingBoxUpdateHandler&&(this._map.off("moveend",this._boundingBoxUpdateHandler),this._map.off("zoomend",this._boundingBoxUpdateHandler));let e=null;this._boundingBoxUpdateHandler=()=>{e&&clearTimeout(e),e=setTimeout(()=>{this.updateData()},300)},this._map.on("moveend",this._boundingBoxUpdateHandler),this._map.on("zoomend",this._boundingBoxUpdateHandler)}_removeBoundingBoxUpdates(){this._boundingBoxUpdateHandler&&(this._map.off("moveend",this._boundingBoxUpdateHandler),this._map.off("zoomend",this._boundingBoxUpdateHandler),this._boundingBoxUpdateHandler=null)}updateSource(){this._map.getSource(this._sourceId)&&this._map.removeSource(this._sourceId),this._createSource()}setWhere(e){this.esriServiceOptions.where=e,this.updateSource()}setOutFields(e){this.esriServiceOptions.outFields=e,this.updateSource()}setLayers(e){this.esriServiceOptions.layers=e,this.updateSource()}setGeometry(e,t){this.esriServiceOptions.geometry=e,t&&(this.esriServiceOptions.geometryType=t),this.updateSource()}clearGeometry(){delete this.esriServiceOptions.geometry,delete this.esriServiceOptions.geometryType,this.updateSource()}setBoundingBoxFilter(e){this.esriServiceOptions.useBoundingBox=e,e&&!1===this.esriServiceOptions.useVectorTiles?this._setupBoundingBoxUpdates():this._removeBoundingBoxUpdates(),this.updateSource()}remove(){if(this._removeBoundingBoxUpdates(),this._map&&"function"==typeof this._map.removeSource)try{const e=this._map;if(e.getStyle){const t=e.getStyle();(t?.layers||[]).forEach(e=>{e.source===this._sourceId&&this._map.getLayer&&this._map.getLayer(e.id)&&this._map.removeLayer(e.id)})}this._map.getSource&&this._map.getSource(this._sourceId)&&this._map.removeSource(this._sourceId)}catch(e){console.warn(`Failed to remove source ${this._sourceId}:`,e)}}async queryFeatures(e){const t={...this.esriServiceOptions,...e},r=this._buildQueryUrlWithOptions(t);try{const e=await fetch(r,this.esriServiceOptions.fetchOptions);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(e){throw"undefined"!=typeof process&&"test"===process.env?.NODE_ENV||console.error("Error querying features:",e),e}}_buildQueryUrlWithOptions(e){const t={...this._defaultEsriOptions,...e},r=`${t.url}/query`,i=new URLSearchParams;return i.append("where",t.where||"1=1"),i.append("outFields",Array.isArray(t.outFields)?t.outFields.join(","):t.outFields||"*"),i.append("f",t.f||"geojson"),i.append("returnGeometry",(!1!==t.returnGeometry).toString()),t.geometry&&(i.append("geometry",JSON.stringify(t.geometry)),t.geometryType&&i.append("geometryType",t.geometryType),t.spatialRel&&i.append("spatialRel",t.spatialRel),t.inSR&&i.append("inSR",t.inSR)),t.outSR&&i.append("outSR",t.outSR),t.orderByFields&&i.append("orderByFields",t.orderByFields),t.groupByFieldsForStatistics&&i.append("groupByFieldsForStatistics",t.groupByFieldsForStatistics),t.outStatistics&&t.outStatistics.length>0&&i.append("outStatistics",JSON.stringify(t.outStatistics)),t.having&&i.append("having",t.having),t.resultOffset&&i.append("resultOffset",t.resultOffset.toString()),t.resultRecordCount&&i.append("resultRecordCount",t.resultRecordCount.toString()),t.token&&i.append("token",t.token),`${r}?${i.toString()}`}},e.Find=l,e.IdentifyFeatures=class extends n{constructor(e){let t;if(t="string"==typeof e?e:e instanceof a?{url:e.options.url}:e,super(t),Object.defineProperty(this,"setters",{enumerable:!0,configurable:!0,writable:!0,value:{layers:"layers",precision:"geometryPrecision",tolerance:"tolerance",returnGeometry:"returnGeometry"}}),Object.defineProperty(this,"path",{enumerable:!0,configurable:!0,writable:!0,value:"/identify"}),Object.defineProperty(this,"params",{enumerable:!0,configurable:!0,writable:!0,value:{sr:4326,layers:"all",tolerance:3,returnGeometry:!0,f:"json"}}),this.path="/identify",this.setters)for(const[e,t]of Object.entries(this.setters))this[e]=this.generateSetter(t,this)}at(e){let t;return t=Array.isArray(e)?{x:e[0],y:e[1],spatialReference:{wkid:4326}}:{x:e.lng,y:e.lat,spatialReference:{wkid:4326}},this.params.geometry=JSON.stringify(t),this.params.geometryType="esriGeometryPoint",this}layers(e){return this.params.layers=e,this}tolerance(e){return this.params.tolerance=e,this}returnGeometry(e){return this.params.returnGeometry=e,this}precision(e){return this.params.geometryPrecision=e,this}on(e){try{const t=e.getBounds().toArray();this.params.mapExtent=[t[0][0],t[0][1],t[1][0],t[1][1]].join(",");const r=e.getCanvas();this.params.imageDisplay=[r.width,r.height,96].join(",")}catch(e){console.warn("Could not extract map extent and display info:",e)}return this}layerDef(e,t){const r=this.params.layerDefs||"";return this.params.layerDefs=r?`${r};${e}:${t}`:`${e}:${t}`,this}simplify(e,t){const r=e.getBounds(),i=Math.abs(r.getWest()-r.getEast());return this.params.maxAllowableOffset=i/e.getSize().x*t,this}async run(){try{const e=await this.request();return this._convertToGeoJSON(e)}catch(e){throw"undefined"!=typeof process&&"test"===process.env?.NODE_ENV||console.error("IdentifyFeatures error:",e),e}}_convertToGeoJSON(e){return{type:"FeatureCollection",features:(e.results||[]).map(e=>{const t={type:"Feature",properties:{...e.attributes,layerId:e.layerId,layerName:e.layerName,displayFieldName:e.displayFieldName,value:e.value},geometry:e.geometry||null};return t.layerId=e.layerId,t})}}},e.IdentifyImage=c,e.ImageService=class{constructor(e,r,i,s){if(Object.defineProperty(this,"_sourceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_map",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_defaultEsriOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serviceMetadata",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"rasterSrcOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"esriServiceOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!i.url)throw new Error("A url must be supplied as part of the esriServiceOptions object.");i.url=t(i.url),this._sourceId=e,this._map=r,this._defaultEsriOptions={layers:!1,layerDefs:!1,dynamicLayers:!1,format:"jpgpng",dpi:96,transparent:!0,getAttributionFromService:!0,time:!1},this.rasterSrcOptions=s,this.esriServiceOptions=i,this._createSource(),this.options.getAttributionFromService&&this.setAttributionFromService().catch(()=>{})}get options(){return{...this._defaultEsriOptions,...this.esriServiceOptions}}get _time(){if(!this.options.to)return!1;let e=this.options.from,t=this.options.to;return e instanceof Date&&(e=e.valueOf()),t instanceof Date&&(t=t.valueOf()),`${e},${t}`}get _source(){const e=this.rasterSrcOptions?.tileSize??256,t=new URLSearchParams({bboxSR:"3857",imageSR:"3857",format:this.options.format,size:`${e},${e}`,f:"image"});return this._time&&t.append("time",this._time),this.options.mosaicRule&&t.append("mosaicRule",JSON.stringify(this.options.mosaicRule)),this.options.renderingRule&&t.append("renderingRule",JSON.stringify(this.options.renderingRule)),{type:"raster",tiles:[`${this.options.url}/exportImage?bbox={bbox-epsg-3857}&${t.toString()}`],tileSize:e,...this.rasterSrcOptions}}_createSource(){this._map.getSource(this._sourceId)||this._map.addSource(this._sourceId,this._source)}_updateSource(){const e=this._map.getSource(this._sourceId);e&&(e.tiles[0]=this._source.tiles[0],e._options=this._source,e.setTiles?e.setTiles(this._source.tiles):(this._map.style.sourceCaches||this._map.style._otherSourceCaches)&&(this._map.style.sourceCaches[this._sourceId].clearTiles(),this._map.style.sourceCaches[this._sourceId].update(this._map.transform)))}setDate(e,t){this.esriServiceOptions.from=e,this.esriServiceOptions.to=t,this._updateSource()}setRenderingRule(e){this.esriServiceOptions.renderingRule=e,this._updateSource()}setMosaicRule(e){this.esriServiceOptions.mosaicRule=e,this._updateSource()}setAttributionFromService(){return this._serviceMetadata?(s(this._serviceMetadata.copyrightText||"",this._sourceId,this._map),Promise.resolve()):this.getMetadata().then(()=>{s(this._serviceMetadata?.copyrightText||"",this._sourceId,this._map)})}getMetadata(){return null!==this._serviceMetadata?Promise.resolve(this._serviceMetadata):new Promise((e,t)=>{r(this.esriServiceOptions.url,this.esriServiceOptions.fetchOptions).then(t=>{this._serviceMetadata=t,e(this._serviceMetadata)}).catch(e=>t(e))})}identify(e,t=!1){const r=this._map.getCanvas(),i=this._map.getBounds().toArray(),s=new URLSearchParams({sr:"4326",geometryType:"esriGeometryPoint",geometry:JSON.stringify({x:e.lng,y:e.lat,spatialReference:{wkid:4326}}),tolerance:"3",returnGeometry:t.toString(),imageDisplay:`${r.width},${r.height},96`,mapExtent:`${i[0][0]},${i[0][1]},${i[1][0]},${i[1][1]}`,f:"json"});return this._time&&s.append("time",this._time),new Promise((e,t)=>{fetch(`${this.esriServiceOptions.url}/identify?${s.toString()}`,this.esriServiceOptions.fetchOptions).then(e=>e.json()).then(t=>e(t)).catch(e=>t(e))})}update(){this._updateSource()}remove(){if(this._map&&"function"==typeof this._map.removeSource)try{const e=this._map;if(e.getStyle){const t=e.getStyle();(t?.layers||[]).forEach(e=>{e.source===this._sourceId&&this._map.getLayer(e.id)&&this._map.removeLayer(e.id)})}this._map.getSource&&this._map.getSource(this._sourceId)&&this._map.removeSource(this._sourceId)}catch(e){console.warn(`Failed to remove source ${this._sourceId}:`,e)}}},e.Query=u,e.Service=a,e.Task=n,e.TiledMapService=class{constructor(e,r,i,s){if(Object.defineProperty(this,"_sourceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_map",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serviceMetadata",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"rasterSrcOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"esriServiceOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!i.url)throw new Error("A url must be supplied as part of the esriServiceOptions object.");i.url=t(i.url),this._sourceId=e,this._map=r,this.rasterSrcOptions=s,this.esriServiceOptions=i,this._createSource(),i.getAttributionFromService&&this.setAttributionFromService().catch(()=>{})}get _source(){return{...this.rasterSrcOptions,type:"raster",tiles:[`${this.esriServiceOptions.url}/tile/{z}/{y}/{x}`],tileSize:this.rasterSrcOptions?.tileSize||256}}_createSource(){this._map.getSource(this._sourceId)||this._map.addSource(this._sourceId,this._source)}setAttributionFromService(){return this._serviceMetadata?(s(this._serviceMetadata.copyrightText||"",this._sourceId,this._map),Promise.resolve()):this.getMetadata().then(()=>{s(this._serviceMetadata?.copyrightText||"",this._sourceId,this._map)})}getMetadata(){return null!==this._serviceMetadata?Promise.resolve(this._serviceMetadata):new Promise((e,t)=>{r(this.esriServiceOptions.url,this.esriServiceOptions.fetchOptions).then(t=>{this._serviceMetadata=t,e(t)}).catch(e=>t(e))})}update(){this._map.getSource(this._sourceId)}remove(){if(this._map&&"function"==typeof this._map.removeSource)try{const e=this._map;if(e.getStyle&&"function"==typeof e.getLayer){const t=e.getStyle(),r=t?.layers||[],i=e.getLayer;r.forEach(e=>{if(e.source===this._sourceId)try{i(e.id)&&this._map.removeLayer(e.id)}catch{}})}if("function"==typeof this._map.getSource){this._map.getSource(this._sourceId)&&this._map.removeSource(this._sourceId)}}catch(e){console.warn(`Failed to remove source ${this._sourceId}:`,e)}}},e.VectorBasemapStyle=o,e.VectorTileService=class{constructor(e,r,i,s){if(Object.defineProperty(this,"_sourceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_map",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_defaultEsriOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serviceMetadata",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"_defaultStyleData",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"vectorSrcOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"esriServiceOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!i.url)throw new Error("A url must be supplied as part of the esriServiceOptions object.");i.url=t(i.url),this._sourceId=e,this._map=r,this._defaultEsriOptions={useDefaultStyle:!0},this.vectorSrcOptions=s,this.esriServiceOptions=i,this._createSource()}get options(){return{...this._defaultEsriOptions,...this.esriServiceOptions}}get _tileUrl(){return null===this._serviceMetadata?"/tile/{z}/{y}/{x}.pbf":this._serviceMetadata.tiles?.[0]||"/tile/{z}/{y}/{x}.pbf"}get _source(){return{...this.vectorSrcOptions||{},type:"vector",tiles:[`${this.options.url}${this._tileUrl}`]}}_createSource(){this._map.getSource(this._sourceId)||this._map.addSource(this._sourceId,this._source)}_mapToLocalSource(e){return{type:e.type,source:this._sourceId,"source-layer":e["source-layer"],layout:e.layout,paint:e.paint}}get defaultStyle(){return this._mapToLocalSource(this._defaultStyleData)}get _styleUrl(){return null===this._serviceMetadata?"resources/styles/root.json":this._serviceMetadata.defaultStyles||"resources/styles/root.json"}getStyle(){return null!==this._defaultStyleData?Promise.resolve(this.defaultStyle):new Promise((e,t)=>{const r=()=>this._retrieveStyle().then(()=>e(this.defaultStyle)).catch(e=>t(e));null===this._serviceMetadata?this.getMetadata().then(()=>r()).catch(e=>t(e)):r()})}_retrieveStyle(){return new Promise((e,t)=>{fetch(`${this.options.url}/${this._styleUrl}`,this.esriServiceOptions.fetchOptions).then(e=>{if(!e.ok)throw new Error(`Failed to fetch style: ${e.status}`);return e.json()}).then(t=>{if(!t||!Array.isArray(t.layers)||0===t.layers.length)throw new Error("VectorTile style document is missing layers.");this._defaultStyleData=t.layers[0],e()}).catch(e=>t(e))})}getMetadata(){return null!==this._serviceMetadata?Promise.resolve(this._serviceMetadata):new Promise((e,t)=>{r(this.esriServiceOptions.url,this.esriServiceOptions.fetchOptions).then(t=>{this._serviceMetadata=t,e(this._serviceMetadata)}).catch(e=>t(e))})}update(){}remove(){const e=this._map;if(e&&"function"==typeof e.removeSource)try{const t=e,r=e,i=e;if("function"==typeof t.getStyle){const e=t.getStyle();(e?.layers||[]).forEach(e=>{if(e.source!==this._sourceId)return;if("function"!=typeof r.getLayer||"function"!=typeof r.removeLayer)return;let t=!1;try{t=Boolean(r.getLayer(e.id))}catch{t=!1}if(t)try{r.removeLayer(e.id)}catch(t){console.warn(`Failed to remove layer ${e.id} for source ${this._sourceId}:`,t)}})}if("function"==typeof i.getSource){let t=!1;try{t=Boolean(i.getSource(this._sourceId))}catch{t=!1}if(t)try{e.removeSource(this._sourceId)}catch(e){console.warn(`Failed to remove source ${this._sourceId}:`,e)}}}catch(e){console.warn(`Failed to remove source ${this._sourceId}:`,e)}}},e.cleanTrailingSlash=t,e.find=function(e){return new l(e)},e.getServiceDetails=r,e.identifyImage=function(e){return new c(e)},e.query=function(e){return new u(e)},e.updateAttribution=s});
//# sourceMappingURL=esri-gl.min.js.map
